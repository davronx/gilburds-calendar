<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gilburd's Calendar</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    :root {
      --bg: #f4f4f4;
      --text: #000;
      --table-bg: #fff;
      --table-header: #eee;
      --today-bg: #ffeb3b;
      --today-border: #f57c00;
      --info-bg: #fff;
      --shadow: rgba(0,0,0,0.1);
      --highlight-bg: #c8e6c9;
    }

    .dark {
      --bg: #121212;
      --text: #fff;
      --table-bg: #1e1e1e;
      --table-header: #2e2e2e;
      --today-bg: #ffd54f;
      --today-border: #ffa000;
      --info-bg: #2c2c2c;
      --shadow: rgba(255,255,255,0.1);
      --highlight-bg: #388e3c;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 2vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 96%;
      padding: 1vh 0;
      font-size: 1.5vh;
    }
    .year-nav {
      display: flex;
      align-items: center;
      gap: 1vh;
    }
    .year-nav button {
      font-size: 1.3vh;
      padding: 0.3vh 1vh;
    }
    .icons {
      display: flex;
      gap: 1vh;
    }
    .icon {
      cursor: pointer;
      font-size: 2vh;
    }

    #yearContainer {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1vh;
      width: 96%;
      flex-grow: 1;
    }
    .month {
      background: var(--table-bg);
      border-radius: 0.5vh;
      padding: 0.5vh;
      box-shadow: 0 0.3vh 0.6vh var(--shadow);
      display: flex;
      flex-direction: column;
    }
    .month-name {
      text-align: center;
      font-size: 1.6vh;
      font-weight: bold;
      margin-bottom: 0.3vh;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 1.1vh;
      flex-grow: 1;
    }
    th, td {
      border: 0.1vh solid #8882;
      text-align: center;
      padding: 0;
      height: 2.2vh;
      font-size: 1.5vh;
      position: relative;
    }
    th {
      background: var(--table-header);
    }
    .today {
      background-color: var(--today-bg);
      font-weight: bold;
      border: 0.2vh solid var(--today-border);
      color: #000;
    }
    .highlight {
      background-color: var(--highlight-bg);
    }

    .converter {
      margin: 1vh 0;
      font-size: 1.4vh;
      padding: 1vh;
      background: var(--table-bg);
      border-radius: 0.5vh;
      box-shadow: 0 0.2vh 0.5vh var(--shadow);
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 1vh;
    }
    .converter label {
      cursor: pointer;
      position: relative;
    }
    .converter label:hover::after {
      content: 'Click label to switch conversion direction.';
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--info-bg);
      color: var(--text);
      padding: 0.5vh;
      font-size: 1.2vh;
      border-radius: 0.5vh;
      white-space: nowrap;
      box-shadow: 0 0.2vh 0.4vh var(--shadow);
    }
    .converter input {
      font-size: 1.4vh;
      padding: 0.3vh;
      margin-left: 0.5vh;
    }
    .info-popup {
      position: absolute;
      bottom: 6vh;
      right: 2vh;
      background: var(--info-bg);
      color: var(--text);
      padding: 1vh;
      border-radius: 0.5vh;
      font-size: 1.3vh;
      box-shadow: 0 0.3vh 0.6vh var(--shadow);
      max-width: 30ch;
      z-index: 1000;
    }

    .day30 {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .day31 {
      position: absolute;
      bottom: 0;
      right: 0;
      font-size: 0.6em;
    }
    @media (orientation: portrait) {
      #yearContainer {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="year-nav">
      <button onclick="changeYear(-1)">◀</button>
      <span id="yearDisplay"></span>
      <button onclick="changeYear(1)">▶</button>
    </div>
    <div class="converter">
      <label id="convLabel" onclick="toggleConversion()" title="Click label to switch conversion direction.">Gregorian Date:</label>
      <input type="date" id="convInput" />
      <button onclick="convertDate()">⇆</button>
      <button id="resetButton" onclick="resetToCurrentDate()" title="Reset" style="display: none;">⟳</button>
      <span id="convResult"></span>
      <span id="infoPopup" class="info-popup" style="display:none">Gilburd's Calendar has 12 months, alternating 30 and 31 days. December has 30 days unless leap year.</span>
    </div>
    <div class="icons">
      <span class="icon" onclick="toggleDarkMode()" title="Toggle dark mode">☀</span>
      <span class="icon" onclick="toggleInfoPopup()" title="About calendar">ℹ</span>
      <span class="icon" onclick="takeScreenshot()" title="Print Screen">⎙</span>
    </div>
  </header>

  <div id="yearContainer"></div>

  <script src="html2canvas.min.js"></script>
  <script>
    let dark = false;
    let convMode = 'greg';
    const weekdays = ["M", "T", "W", "T", "F", "S"];
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    let currentYear = new Date().getFullYear();
    const today = new Date();
    const todayGilburd = getGilburdDateFromGregorian(today);
  
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      dark = !dark;
    }
    function toggleInfoPopup() {
      const el = document.getElementById('infoPopup');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
    function isLeapYear(year) {
      return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    }
    function getMonthLength(month, year) {
      if (month === 12 && !isLeapYear(year)) return 30;
      return (month % 2 === 0) ? 31 : 30;
    }
    function getWeekLength(month, weekIndex, year) {
      return 6;
    }
    function getGilburdDateFromGregorian(gDate) {
      const year = gDate.getFullYear();
      const start = new Date(year, 0, 1);
      const dayOfYear = Math.floor((gDate - start) / 86400000) + 1;
      const gilburdMonths = [];
      for (let m = 1; m <= 12; m++) {
        let days = (m % 2 === 0) ? 31 : 30;
        if (m === 12 && !isLeapYear(year)) days = 30;
        gilburdMonths.push(days);
      }
      let remaining = dayOfYear;
      for (let i = 0; i < 12; i++) {
        if (remaining <= gilburdMonths[i]) {
          return { year: year, month: i + 1, day: remaining };
        }
        remaining -= gilburdMonths[i];
      }
      return null;
    }
    function getGregorianFromGilburd(gilDate) {
      let days = 0;
      for (let i = 1; i < gilDate.month; i++) {
        days += getMonthLength(i, gilDate.year);
      }
      days += gilDate.day - 1;
      const gDate = new Date(gilDate.year, 0, 1);
      gDate.setDate(gDate.getDate() + days);
      return gDate;
    }
    function renderMonth(month, year) {
      const monthLength = getMonthLength(month, year);
      let day = 1;
      const div = document.createElement("div");
      div.className = "month";
      const title = document.createElement("div");
      title.className = "month-name";
      title.textContent = monthNames[month - 1];
      div.appendChild(title);
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      weekdays.forEach(w => {
        const th = document.createElement("th");
        th.textContent = w;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      for (let w = 0; w < 5; w++) {
        const tr = document.createElement("tr");
        const weekLen = getWeekLength(month, w, year);
        for (let d = 0; d < weekLen; d++) {
          const td = document.createElement("td");
          if (day <= monthLength) {
            if (day === 30 && monthLength === 31) {
              const span30 = document.createElement("span");
              span30.className = "day30";
              span30.textContent = "30";
              const span31 = document.createElement("span");
              span31.textContent = "31";
              span31.className = "day31";
              td.appendChild(span30);
              td.appendChild(span31);
              if (year === today.getFullYear() && month === todayGilburd.month) {
                if (todayGilburd.day === 30) {
                  span30.classList.add("today");
                } else if (todayGilburd.day === 31) {
                  span31.classList.add("today");
                }
              }
              day += 2;
            } else {
              td.textContent = day;
              if (
                year === today.getFullYear() &&
                month === todayGilburd.month &&
                day === todayGilburd.day
              ) {
                td.classList.add("today");
              }
              day++;
            }
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      div.appendChild(table);
      return div;
    }
    function renderYear(year) {
      document.getElementById("yearDisplay").textContent = `Year ${year}`;
      const container = document.getElementById("yearContainer");
      container.innerHTML = "";
      for (let month = 1; month <= 12; month++) {
        container.appendChild(renderMonth(month, year));
      }
    }
    function changeYear(offset) {
      currentYear += offset;
      renderYear(currentYear);
    }
    function toggleConversion() {
      convMode = convMode === 'greg' ? 'gilb' : 'greg';
      document.getElementById("convLabel").textContent = convMode === 'greg' ? "Gregorian Date:" : "Gilburd Date:";
      document.getElementById("convInput").value = "";
      document.getElementById("convResult").textContent = "";
      document.getElementById("resetButton").style.display = "none";
    }
    function convertDate() {
      const input = document.getElementById("convInput").value;
      const result = document.getElementById("convResult");
      if (!input) {
        result.textContent = "Please select a date.";
        return;
      }
      document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));

      if (convMode === 'greg') {
        const gDate = new Date(input);
        const gil = getGilburdDateFromGregorian(gDate);
        result.textContent = `→ Gilburd: ${gil.year}.${gil.month}.${gil.day}`;
        currentYear = gil.year;
        renderYear(currentYear);
        highlightDate(gil.year, gil.month, gil.day);
      } else {
        const [y, m, d] = input.split('-').map(Number);
        const gDate = getGregorianFromGilburd({ year: y, month: m, day: d });
        result.textContent = `→ Gregorian: ${gDate.toISOString().split('T')[0]}`;
        currentYear = y;
        renderYear(currentYear);
        highlightDate(y, m, d);
      }
      document.getElementById("resetButton").style.display = "inline";
    }
    function highlightDate(year, month, day) {
      const monthDiv = document.querySelectorAll('.month')[month - 1];
      const cells = monthDiv.querySelectorAll('td');
      cells.forEach(cell => {
        if (cell.querySelector('.day30') && cell.querySelector('.day31')) {
          const span30 = cell.querySelector('.day30');
          const span31 = cell.querySelector('.day31');
          if (day === 30) {
            span30.classList.add('highlight');
          } else if (day === 31) {
            span31.classList.add('highlight');
          }
        } else if (cell.textContent == day) {
          cell.classList.add('highlight');
        }
      });
    }
    function resetToCurrentDate() {
      currentYear = today.getFullYear();
      renderYear(currentYear);
      document.getElementById("convInput").value = "";
      document.getElementById("convResult").textContent = "";
      document.getElementById("resetButton").style.display = "none";
    }
    renderYear(currentYear);
    function printCalendar() {
      window.print();
    }

    function takeScreenshot() {
      const header = document.querySelector('header');
      const converter = document.querySelector('.converter');
      const buttons = document.querySelectorAll('button');
      const todayElements = document.querySelectorAll('.today');
      
      header.style.display = 'none';
      converter.style.display = 'none';
      buttons.forEach(button => button.style.display = 'none');
      todayElements.forEach(el => el.classList.remove('today'));

      // Take screenshot of the body
      html2canvas(document.body).then(canvas => {
        // Restore visibility of hidden elements
        header.style.display = '';
        converter.style.display = '';
        buttons.forEach(button => button.style.display = '');
        todayElements.forEach(el => el.classList.add('today'));

        // Create a link to download the screenshot
        const link = document.createElement('a');
        link.href = canvas.toDataURL();
        link.download = 'gilburds-calendar-screenshot.png';
        link.click();
      });
    }
  </script>
</body>
</html>
